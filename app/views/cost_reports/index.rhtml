<% content_for :header_tags do %>
  <%= javascript_include_tag "select_list_move_optgroup", :plugin => "redmine_reporting" %>
  <%= javascript_include_tag "reporting", :plugin => "redmine_reporting" %>
<% end %>

<% if @custom_error %>
  <div class="flash error"><%= @custom_error %></div>
<% end %>

<h2><%= l(:label_cost_report) %></h2>
<% html_title( l(:label_cost_report) ) %>

<% form_for @query, :url => {:controller => 'cost_report', :action => 'new' }, :html => {:id => 'query_form', :method => :post} do |query_form| %>
<div id="query_form_content">
  <fieldset id="filters" class="collapsible <%= "collapsed" unless @query.new_record? %>">
    <legend onclick="toggleFieldset(this);"><%= l(:label_filter_plural) %></legend>
    <div <%= 'style="display:none;"' unless @query.new_record? %>><%= render :partial => 'filters', :locals => {:f => query_form, :query => @query} %></div>
  </fieldset>

  <fieldset id="group-by" class="collapsible <%= "collapsed" unless @query.new_record? %>">
    <legend onclick="toggleFieldset(this);"><%= l(:label_group_by) %></legend>
    <div <%= 'style="display:none;"' unless @query.new_record? %>><%= render :partial => 'group_by', :locals => {:f => query_form, :query => @query} %></div>
  </fieldset>

  <%= render :partial => 'restore_query', :locals => {:f => query_form, :query => @query} %>
  <p class="buttons">
  <%= link_to_remote l(:button_apply),
                     { :url => { :set_filter => 1 },
                       :before => 'selectAllOptions("group_by_rows");selectAllOptions("group_by_columns");',
                       :update => "content",
                       :with => "Form.serialize('query_form')",
                       :eval_scripts => true
                     }, :class => 'icon icon-checked' %>

  <%= link_to_remote l(:button_clear),
                     { :url => { :set_filter => 1 },
                       :update => "content",
                       :eval_scripts => true
                     }, :class => 'icon icon-reload'  %>
  <% if User.current.allowed_to?(:save_queries, @project, :global => true) %>
  <%
    #link_to l(:button_save), {}, :onclick => "$('query_form').submit(); return false;", :class => 'icon icon-save'
  %>
  <% end %>
  </p>
</div>
<% end %>

<%= render :partial => @table_partial, :locals => {:query => @query, :walker => @query.walker} %>
